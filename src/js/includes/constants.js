const NodeStl = require('node-stl');

// Constant variables used for shopping & delivery, product customization
const SHIPPING_PRICE = 990;
const MONEY_HANDLE = 390;
const LIT_FORMS = ['Domború', 'Homorú', 'Sima'];
const LIT_PRICES = {'100': 1990, '150': 2990, '200': 3990};
const PRINT_COLORS = ['Fekete', 'Fehér', 'Kék', 'Zöld', 'Arany', 'Piros', 'Sárga',
  'Zölden Foszforeszkáló'];
const HEX_ARR = ['#000000', '#ffffff', '#0089ff', '#7aff00', 'gold', 'red', '#FFFF00',
  '#90EE90'];
const LAYER_WIDTH_VALUES = [0.12, 0.2, 0.28];
const INFILL_VALUES = [10];
for (let i = 20; i <= 80; i += 20) {
  INFILL_VALUES.push(i);
}

const SCALE_VALUES = [2];
for (let i = 0.7; i <= 1.3; i += 0.3) {
  SCALE_VALUES.push(Number(i.toFixed(2)));
}

const WALL_WIDTH_VALUES = [];
for (let i = 0.8; i <= 2.4; i += 0.4) {
  WALL_WIDTH_VALUES.push(Number(i.toFixed(2)));
}

const DR = __dirname.replace('js/includes', '');

const FILES_TO_CACHE = [
  DR + 'animate/animate.css',
  DR + 'js/includes/jq.js',
  DR + 'js/includes/lazyLoad.js'
];

const COUNTRIES = ["Albánia", "Andorra", "Argentína", "Ausztrália", "Ausztria", "Azerbajdzsán",
    "Belgium", "Bosznia-Hercegovina", "Brazília", "Bulgária", "Kanada", "Chile", "Kína",
    "Horvátország", "Kuba", "Ciprus", "Cseh köztársaság", "Dánia", "Egyiptom", "Észtország",
    "Faroe-szigetek", "Finnország", "Franciaország", "Grúzia", "Németország", "Gibraltár",
    "Görögország", "Hong Kong", "Magyarország", "Izland", "India", "Indonézia", "Irán", "Irak",
    "Írország", "Izrael", "Olaszország", "Japán", "Kazahsztán", "Dél-Koreai Köztársaság",
    "Kuwait",
    "Lettország", "Liechtenstein", "Litvánia", "Luxemburg", "Makedónia", "Malajzia", "Málta",
    "Mexikó", "Monaco", "Marokkó", "Hollandia", "Új-Zéland", "Norvégia", "Paraguay",
    "Fülöp-szigetek", "Lengyelország", "Portugália", "Katar", "Románia", "Oroszország",
    "San Marino", "Szaud-Arábia", "Szlovákia", "Szlovénia", "Dél-afrikai Köztársaság",
    "Spanyolország", "Svédország", "Svájc", "Thaiföld", "Tunézia", "Törökország",
    "Türkmenisztán",
    "Ukrajna", "Egyesült Arab Emirátusok", "Egyesült Királyság", "Amerikai Egyesült Államok",
    "Uruguay", "Üzbégisztán", "Vatikáni városállam", "Venezuela", "Vietnám", "Szerbia",
    "Koszovó",
    "Montenegró"];

const MIN_PRICE = 800;
const FIX_ADD_CPRINT = 500;
const SUCCESS_RETURN = '{"success": true}';

// For printing
const B = 40; // build speed: 40mm/s
const N = 0.4; // nozzle size: 0.4mm
const T = 1; // thermal expansion
const De = 0.2; // default infill in percentage
const L = 0.2; // default layer height in mm
const M = 12; // cost/min in forint
const DENSITY = 1.27; // PLA density is 1.27 g/cm^3

// Create a piecewise defined function for smoothing out the price when its too big
function smoothPrice(P) {
  if (P <= 10000) {
    // f(x) = x
    return P;
  } else if (P <= 20000) {
    // f(x) = (-1.6 * 10 ^ (-5))x + 1.03
    return P * (-1.6 * Math.pow(10, -5) * P + 1.03);
  } else if (P <= 40000) {
    // f(x) = (-1.6 * 10 ^ (-5))x + 1.13
    return P * (-1.6 * Math.pow(10, -5) * P + 1.13);
  } else if (P <= 60000) {
    // f(x) = (-1.6 * 10 ^ (-5))x + 1.43
    return P * (-1.6 * Math.pow(10, -5) * P + 1.43);
  } else if (P <= 80000) {
    // f(x) = (-1.6 * 10 ^ (-5))x + 1.78
    return P * (-1.6 * Math.pow(10, -5) * P + 1.78);
  } else if (P <= 100000) {
    // f(x) = (-1.6 * 10 ^ (-5))x + 2.1
    return P * (-1.6 * Math.pow(10, -5) * P + 2.1);
  } else if (P <= 120000) {
    // f(x) = (-1.6 * 10 ^ (-5))x + 2.42
    return P * (-1.6 * Math.pow(10, -5) * P + 2.42);
  } else {
    // f(x) = (-1.6 * 10 ^ (-5))x + 2.75
    return P * (-1.6 * Math.pow(10, -5) * P + 2.75);
  }
}

// Calculate the price of a model from estimated print time

/*
  ORIGINAL:
  function calcCPPrice(W, H, D) {
    // If price is above 5K Ft then free after work, otherwise add +1K Ft
    let price = Math.round(smoothPrice(((W / B) * (D / ((N / T) / De)) * (H / L)) / 60 * M));
    if (price < 5000) return (price + 1000);
    else return price;
  }
*/

function calcCPPrice(W, H, D) {
  // If price is above 5K Ft then free after work, otherwise add +1K Ft
  let price = Math.round(smoothPrice(((W / B) * (D / ((N / T) / De)) * (H / L)) / 60 * M));
  if (price < 5000) return Math.round((price + 1000) * 0.5);
  else return Math.round(price * 0.5);
}

// Get bounding box x, y, z coords
function getCoords(path) {
  let stl = new NodeStl(path, {density: DENSITY}); 
  let bbox = stl.boundingBox;
  return [bbox[0], bbox[1], bbox[2]];
}

function getPrintTime(W, H, D) {
  return Math.round((W / B) * (D / ((N / T) / De)) * (H / L));
}

// Constants for reference page
const NUM_OF_COLS = 3;
const NUM_OF_IMGS = 3;

const REF_BG = `
  data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAA0NDQ0ODQ4QEA4UFhMWFB4bGRkbHi0gIiAiIC1EKjIqKjIqRDxJOzc7STxsVUtLVWx9aWNpfZeHh5e+tb75+f8BDQ0NDQ4NDhAQDhQWExYUHhsZGRseLSAiICIgLUQqMioqMipEPEk7NztJPGxVS0tVbH1pY2l9l4eHl761vvn5///CABEIA+cD5wMBIgACEQEDEQH/xAAVAAEBAAAAAAAAAAAAAAAAAAAABf/aAAgBAQAAAACyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAgBAhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf//EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAIAQMQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//xAAUEAEAAAAAAAAAAAAAAAAAAADQ/9oACAEBAAE/AHQn/8QAFBEBAAAAAAAAAAAAAAAAAAAAsP/aAAgBAgEBPwB4H//EABQRAQAAAAAAAAAAAAAAAAAAALD/2gAIAQMBAT8AeB//2Q==
`;

module.exports = {
  'shippingPrice': SHIPPING_PRICE,
  'moneyHandle': MONEY_HANDLE,
  'countries': COUNTRIES,
  'minPrice': MIN_PRICE,
  'fixAddCprint': FIX_ADD_CPRINT,
  'successReturn': SUCCESS_RETURN,
  'calcCPPrice': calcCPPrice,
  'getPrintTime': getPrintTime,
  'getCoords': getCoords,
  'M': M,
  'numOfCols': NUM_OF_COLS,
  'numOfImgs': NUM_OF_IMGS,
  'filesToCache': FILES_TO_CACHE,
  'refBg': REF_BG,
  'printColors': PRINT_COLORS,
  'litForms': LIT_FORMS,
  'hexArr': HEX_ARR,
  'layerWidthValues': LAYER_WIDTH_VALUES,
  'infillValues': INFILL_VALUES,
  'scaleValues': SCALE_VALUES,
  'wallWidthValues': WALL_WIDTH_VALUES,
  'litPrices': LIT_PRICES
};
